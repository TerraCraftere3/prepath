name: CMake on Windows

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: "latest"

    - name: Set reusable strings
      id: strings
      shell: powershell
      run: echo "build-output-dir=${Env:GITHUB_WORKSPACE}\build" >> $Env:GITHUB_OUTPUT

    - name: Configure CMake
      shell: powershell
      run: cmake -B $Env:GITHUB_WORKSPACE\build `
                 -DCMAKE_CXX_COMPILER=cl `
                 -DCMAKE_C_COMPILER=cl `
                 -DCMAKE_BUILD_TYPE=Release `
                 -S $Env:GITHUB_WORKSPACE

    - name: Build
      shell: powershell
      run: cmake --build $Env:GITHUB_WORKSPACE\build --config Release

    - name: Test
      shell: powershell
      working-directory: $Env:GITHUB_WORKSPACE\build
      run: ctest --build-config Release
